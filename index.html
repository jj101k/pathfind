<!DOCTYPE html>
<html>
    <head>
        <title>Pathfinding test</title>
        <style type="text/css">
            #grid {
                border: 1px solid black;
                width: 600px;
                height: 600px;
                margin-left: auto;
                margin-right: auto;
                display: inline-block;
            }
        </style>
    </head>
    <body>
        <table style="width: 300px; float: right">
            <thead>
                <tr>
                    <th>Test</th>
                    <th>Result</th>
                    <th>Runtime (ms)</th>
                    <th>Expected</th>
                </tr>
            </thead>
            <tbody id="test-results">

            </tbody>
        </table>
        <canvas id="grid"></canvas>
        <section id="config-form">
            <p>Import .wasm core <input type="file" id="wasm-import"/></p>
            <p><label>
                Random size
                <input type="number" data-readwrite="size"/>
                x
                <span data-read="size">?</span>
            </label></p>
            <p><label>
                Obstruction density
                <input type="number" min="0"
            max="0.5" step="0.1" value="0.5" data-readwrite="density"/>
            </label></p>
            <p><label><input type="checkbox" data-readwrite="randomCornerToCorner">Random is corner-to-corner</label></p>
            <p><label>Test <input type="number" data-readwrite="testNumber"/></label></p>
            <p><label><input type="checkbox" data-readwrite="paused">Pause</label></p>
            <p><label><input type="checkbox" data-readwrite="blind">Disable display updates</label></p>
            <p>
                <button type="button" data-call="step">Step</button>
                <button type="button" data-call="nextTest">Next test</button>
                <button type="button" data-call="randomTest">Random test</button>
                <button type="button" data-call="nullTest">Null test</button>
                <button type="button" data-call="runAll">All tests</button>
            </p>
        </section>
        <script src="index.js"></script>
        <script src="GridMap.js"></script>
        <script src="PositionedNode.js"></script>
        <script src="RouteStepper.js"></script>
        <script src="PathNode.js"></script>
        <script src="Route.js"></script>
        <script src="GridTest.js"></script>
        <script src="core.js"></script>
        <script src="test.js"></script>
        <script src="self-test.js"></script>
        <script>
            let t = new GridTest()

            /**
             * @type {HTMLElement}
             */
            const form = document.querySelector("#config-form")

            const retainedData = {
                _testNumber: null,
                size: 300,
                nextTest: () => t.nextTest(),
                nullTest() {
                    return t.nullTest(this.size)
                },
                randomTest() {
                    return t.randomTest(this.size)
                },
                runAll: () => t.runAll(),
                step: () => t.step(),
                get blind() {
                    return t.blind
                },
                set blind(v) {
                    t.blind = v
                },
                get density() {
                    return t.density
                },
                set density(v) {
                    t.density = v
                },
                get paused() {
                    return t.paused
                },
                set paused(v) {
                    t.paused = v
                },
                get randomCornerToCorner() {
                    return t.randomCornerToCorner
                },
                set randomCornerToCorner(v) {
                    t.randomCornerToCorner = v
                },
                get testNumber() {
                    return this._testNumber
                },
                set testNumber(v) {
                    this._testNumber = v
                    t.selectTest(v)
                }
            }
            class Frameworker {
                /**
                 * @type {Record<string, (() => any)[]}
                 */
                #listeners = {}

                /**
                 * @type {Record<string, any>}
                 */
                #retainedData

                /**
                 * @type {Record<string, any>}
                 */
                constructor(retainedData) {
                    this.#retainedData = retainedData
                }

                /**
                 * @param {HTMLElement} form
                 */
                init(form) {
                    for(const e of form.querySelectorAll("[data-readwrite]")) {
                        /**
                         * @type {HTMLInputElement}
                         */
                        const he = e
                        const key = he.dataset.readwrite
                        this.#listeners[key] = this.#listeners[key] || []
                        if(he.type == "checkbox") {
                            he.onchange = function() {
                                this.#retainedData[key] = this.checked
                                for(const l of this.#listeners[key]) {
                                    l()
                                }
                            }
                            he.checked = this.#retainedData[key]
                        } else {
                            he.onchange = function() {
                                this.#retainedData[key] = this.value
                                for(const l of this.#listeners[key]) {
                                    l()
                                }
                            }
                            he.value = this.#retainedData[key]
                        }
                    }
                    for(const e of form.querySelectorAll("[data-read]")) {
                        /**
                         * @type {HTMLElement}
                         */
                        const he = e
                        const key = he.dataset.read
                        this.#listeners[key] = this.#listeners[key] || []
                        this.#listeners[key].push(
                            () => he.textContent = this.#retainedData[key]
                        )
                        he.textContent = this.#retainedData[key]
                    }

                    for(const e of form.querySelectorAll("[data-call]")) {
                        /**
                         * @type {HTMLButtonElement}
                         */
                        const he = e
                        const key = he.dataset.call
                        he.onclick = function() {
                            this.#retainedData[key]()
                        }
                    }
                }
            }

            const f = new Frameworker(retainedData)
            f.init(form)

            t.tests = PathTests
            t.randomTest(retainedData.size)
        </script>
    </body>
</html>